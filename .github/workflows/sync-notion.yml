name: Sync Notion to Blog

on:
  schedule:
    # 매 6시간마다 실행 (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'

  workflow_dispatch:  # 수동 실행 가능

  repository_dispatch:  # 외부 웹훅 (Make에서 호출)
    types: [notion-webhook]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci
          echo "Installed packages:"
          npm list --depth=0

      - name: Sync from Notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          SYNC_ACTION: ${{ github.event.client_payload.action }}
          SYNC_PAGE_ID: ${{ github.event.client_payload.page_id }}
          TRIGGER_TYPE: ${{ github.event_name }}
        run: node scripts/sync-notion.js

      - name: Check for changes
        id: check_changes
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Configure Git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "Notion Sync Bot"
          git config --global user.email "notion-sync[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add -A content/posts/
          git add -A public/notion-images/

          git commit -m "Sync blog posts from Notion"

          git pull --rebase origin main
          git push origin main

      - name: Report completion
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "✅ Notion sync completed and deployed!"
          echo "Vercel will automatically deploy the changes in 1-2 minutes."

      - name: No changes
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "ℹ️ No new or updated posts found in Notion"
          echo "All published posts are already synced"
