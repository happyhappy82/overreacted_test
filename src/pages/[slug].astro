---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import QnA from "@/components/QnA.astro";
import { getSortedPostsData, getPostBySlug } from "@/lib/posts";
import { extractQnA, removeQnASection } from "@/lib/qna-utils";
import { marked } from "marked";

export function getStaticPaths() {
  const posts = getSortedPostsData();
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect("/404");
}

// Extract Q&A and remove from main content
const qnaItems = extractQnA(post.content);
const contentWithoutQnA = removeQnASection(post.content);

// Generate ID from text for headings
function generateId(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9가-힣\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-")
    .trim();
}

// Extract headings for TOC
interface Heading {
  id: string;
  text: string;
  level: number;
}

function extractHeadings(content: string): Heading[] {
  const headingRegex = /^(#{2,3})\s+(.+)$/gm;
  const headings: Heading[] = [];
  let match;

  while ((match = headingRegex.exec(content)) !== null) {
    const level = match[1].length;
    const text = match[2].replace(/\*\*/g, "");
    const id = generateId(text);
    headings.push({ id, text, level });
  }

  return headings;
}

const headings = extractHeadings(contentWithoutQnA);

// Custom marked renderer
const renderer = new marked.Renderer();

renderer.heading = function (token: any) {
  const text = token.text || "";
  const depth = token.depth;
  const cleanText = text.replace(/\*\*/g, "");
  const id = generateId(cleanText);
  const content = this.parser.parseInline(token.tokens);
  return `<h${depth} id="${id}">${content}</h${depth}>`;
};

renderer.image = function ({ href, text }) {
  const alt = text || post.title;
  return `<img src="${href}" alt="${alt}" loading="lazy" class="rounded-lg max-w-full h-auto" />`;
};

renderer.table = function (token: any) {
  let headerHtml = '<tr>';
  token.header.forEach((cell: any) => {
    headerHtml += `<th align="${cell.align || ''}">${this.parser.parseInline(cell.tokens)}</th>`;
  });
  headerHtml += '</tr>';

  let bodyHtml = '';
  token.rows.forEach((row: any) => {
    bodyHtml += '<tr>';
    row.forEach((cell: any) => {
      bodyHtml += `<td align="${cell.align || ''}">${this.parser.parseInline(cell.tokens)}</td>`;
    });
    bodyHtml += '</tr>';
  });

  return `<div class="overflow-x-auto"><table><thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody></table></div>`;
};

marked.setOptions({
  renderer,
  gfm: true,
  breaks: false,
});

const htmlContent = marked.parse(contentWithoutQnA) as string;

const url = `https://blog.aijeong.com/${slug}`;
const displayDate = post.date.split("T")[0];

// Article Schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.title,
  description: post.excerpt,
  datePublished: post.date,
  dateModified: post.date,
  author: {
    "@type": "Organization",
    name: "에이정",
    url: "https://blog.aijeong.com",
  },
  publisher: {
    "@type": "Organization",
    name: "에이정",
    logo: {
      "@type": "ImageObject",
      url: "https://blog.aijeong.com/logo.png",
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": url,
  },
};

// BreadcrumbList Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "홈",
      item: "https://blog.aijeong.com",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: post.title,
      item: url,
    },
  ],
};

// FAQPage Schema (only if Q&A exists)
const faqSchema =
  qnaItems.length > 0
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: qnaItems.map((item) => ({
          "@type": "Question",
          name: item.question,
          acceptedAnswer: {
            "@type": "Answer",
            text: item.answer,
          },
        })),
      }
    : undefined;
---

<Layout
  title={`${post.title} — 에이정`}
  description={post.excerpt}
  canonical={url}
  ogType="article"
  publishedTime={post.date}
  articleSchema={articleSchema}
  breadcrumbSchema={breadcrumbSchema}
  faqSchema={faqSchema}
>
  <Header />
  <TableOfContents headings={headings} />

  <main>
    <article class="prose prose-lg max-w-none">
      <h1
        class="text-[48px] font-black leading-tight mb-2"
        style={`color: ${post.lightColor}`}
      >
        {post.title}
      </h1>
      <p class="text-[13px] text-gray-700 mb-8">
        <time datetime={post.date}>{displayDate}</time> · {post.readingTime}
      </p>
      <div class="mt-8" set:html={htmlContent} />

      {qnaItems.length > 0 && (
        <>
          <h2 id="자주-묻는-질문" class="mt-12 mb-6">자주 묻는 질문</h2>
          <QnA items={qnaItems} />
        </>
      )}
    </article>
  </main>
</Layout>

<style>
  .code-block-wrapper {
    position: relative;
  }
  .copy-button {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    font-size: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: #888;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .code-block-wrapper:hover .copy-button {
    opacity: 1;
  }
  .copy-button:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }
  .copy-button.copied {
    color: #22c55e;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('pre');

    codeBlocks.forEach((pre) => {
      // 이미 wrapper가 있으면 스킵
      if (pre.parentElement?.classList.contains('code-block-wrapper')) return;

      // wrapper div 생성
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // 복사 버튼 생성
      const button = document.createElement('button');
      button.className = 'copy-button';
      button.textContent = '복사';
      button.setAttribute('aria-label', '코드 복사');

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent || pre.textContent || '';

        try {
          await navigator.clipboard.writeText(code);
          button.textContent = '복사됨!';
          button.classList.add('copied');

          setTimeout(() => {
            button.textContent = '복사';
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          button.textContent = '실패';
          setTimeout(() => {
            button.textContent = '복사';
          }, 2000);
        }
      });

      wrapper.appendChild(button);
    });
  });
</script>
